<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Happy Birthday name üéâ</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <style>
    html, body { 
      margin: 0; 
      height: 100%; 
      overflow: hidden; 
      background: linear-gradient(to bottom right, #E6F5D6, #8ECF82); 
    }

    #loadingScreen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(to bottom right, #E6F5D6, #8ECF82);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      color: #fff;
      font-family: 'Pacifico', cursive;
    }

    .ml11 {
      font-weight: 500;
      font-size: clamp(2.2rem, 4vw, 3rem);
      white-space: nowrap;
      overflow: hidden;
    }

    .loading-bar-container {
      width: 350px;
      height: 28px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 20px;
      position: relative;
    }

    .loading-bar {
      height: 100%;
      width: 0%;
      background: #2fbf9b;
      transition: width 0.2s;
    }

    .loading-percentage {
      margin-top: 5px;
      font-size: 26px;
      font-family: 'Pacifico', cursive;
    }

    .continue-text {
      opacity: 0;
      margin-top: 15px;
      font-size: 26px;
      font-family: 'Pacifico', cursive;
      transition: opacity 0.5s;
    }

    #globeViz { 
      width: 100vw; 
      height: 100vh; 
      position: relative;
      z-index: 1;
    }

    .popup {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 15px 20px;
      border-radius: 10px;
      font-family: 'Pacifico', cursive;
      font-size: 18px;
      display: none;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
    }

    .title {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      font-family: 'Pacifico', cursive;
      font-size: clamp(2.8rem, 5vw, 4rem);
      color: #fff;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.4);
      z-index: 5;
    }

    .subtitle {
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      font-family: 'Pacifico', cursive;
      font-size: clamp(1.5rem, 3vw, 2.5rem);
      color: #fff;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.4);
      z-index: 5;
    }

    /* ===== Desktop default ===== */
    .card {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 248, 240, 0.9);
      padding: 16px 22px;
      border-radius: 12px;
      text-align: center;
      width: 820px;                  
      max-height: none;
      overflow-y: visible;
      z-index: 5;
      display: none;                 
      visibility: hidden;            
      font-family: 'Pacifico', cursive;
      font-size: clamp(18px, 1.15vw, 24px);
    }

    .nav-buttons {
      position: absolute;
      bottom: 80px;
      width: 100%;
      text-align: center;
      z-index: 6;
    }

    .nav-buttons button {
      padding: clamp(10px, 3vw, 20px) clamp(16px, 4vw, 40px);
      font-size: clamp(28px, 4vw, 50px);
      cursor: pointer;
      border: none;
      background: #2fbf9b;
      color: white;
      border-radius: 8px;
      margin: 0 10px;
      font-family: 'Pacifico', cursive;
      transition: opacity 0.3s;
    }

    .nav-buttons button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #airplane {
      position: absolute;
      font-size: 100px;
      z-index: 9999;
      transition: transform 1s linear;
      display: block;
    }

    canvas.confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 0 !important;
      pointer-events: none;
    }

    @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(47,191,155,.7)} 70%{box-shadow:0 0 0 15px rgba(47,191,155,0)} 100%{box-shadow:0 0 0 0 rgba(47,191,155,0)} }
    .pulsing { animation: pulse 2s infinite; }

    @media screen and (max-width: 600px) {
      .ml11 { font-size: 1.4rem; }
      .loading-bar-container { height: 20px; width: 85%; }
      .loading-percentage, .continue-text { font-size: 18px; }
      .title { font-size: 1.6rem; }
      .subtitle { font-size: 1rem; }
      #airplane { font-size: 50px; }

      /* ===== Mobile cards: unified shorter height, no scroll ===== */
      .card {
        width: min(95vw, 420px);
        padding: 10px 12px;
        font-size: clamp(14px, 4vw, 18px);
        height: var(--card-target-height, 340px);
        max-height: var(--card-target-height, 340px);
        overflow-y: hidden;
      }

      /* Keep slideshow size (do NOT shrink it) */
      .slideshow { height: 180px; }
      .card img {
        display: block;
        width: 100%;
        height: auto;
        object-fit: cover;
        border-radius: 5px;
      }
      .card p { margin: 8px 0 0; line-height: 1.25; }
    }

    @keyframes pulseFade { 0%,100%{opacity:.5;transform:scale(1)} 50%{opacity:1;transform:scale(1.05)} }
    @keyframes vibrate {
      0% { transform: translateX(0); }
      20% { transform: translateX(-1px); }
      40% { transform: translateX(1px); }
      60% { transform: translateX(-1px); }
      80% { transform: translateX(2px); }
      100% { transform: translateX(0); }
    }
    .pulsating-vibrating { animation: pulseFade 1.5s infinite ease-in-out, vibrate 1s infinite linear; }

    /* Slideshow base (desktop & mobile) */
    .slideshow { position: relative; width: 100%; height: 260px; overflow: hidden; border-radius: 6px; }
    .slideshow .slide { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; object-position: center; opacity: 0; transition: opacity .5s ease; background: #fff; }
    .slideshow .slide.active { opacity: 1; }

    /* Overlay arrows on the slideshow image (saves vertical space) */
    .arrow-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(47, 191, 155, 0.85);
      color: #fff;
      border: none;
      border-radius: 999px;
      width: 34px;
      height: 34px;
      line-height: 34px;
      text-align: center;
      font-family: 'Pacifico', cursive;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      user-select: none;
    }
    .arrow-left { left: 8px; }
    .arrow-right { right: 8px; }

    /* Controls row now just holds dots; tiny margin to save space */
    .slide-controls { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 2px; }
    .slide-controls button { background: #2fbf9b; color: #fff; border: none; border-radius: 6px; padding: 4px 10px; cursor: pointer; font-family: 'Pacifico', cursive; font-size: 16px; }
    .dots { display: flex; gap: 6px; align-items: center; justify-content: center; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #d7f3ea; display: inline-block; cursor: pointer; }
    .dot.active { background: #2fbf9b; }

    /* Refresh button style (added) */
    .refresh-btn {
      padding: clamp(10px, 3vw, 20px) clamp(16px, 4vw, 40px);
      font-size: clamp(20px, 3vw, 32px);
      cursor: pointer;
      border: none;
      background: #2fbf9b;
      color: white;
      border-radius: 8px;
      margin-top: 12px;
      font-family: 'Pacifico', cursive;
    }
  </style>
</head>
<body>
  <div id="loadingScreen">
    <div class="ml11">
      <span class="letters">Preparing your surprise5<span id="dots">...</span></span>
    </div>
    <div class="loading-bar-container">
      <div class="loading-bar" id="loadingBar"></div>
    </div>
    <div class="loading-percentage" id="loadingPercentage">0%</div>
    <div class="continue-text" id="continueText">[Press ENTER or Tap to continue]</div>
  </div>

  <div class="title">üéÇ Happy Birthday name üéÇ</div>
  <div id="globeViz"></div>
  <div id="popup" class="popup"></div>
  <div class="subtitle">From Turkey to Azerbaijan, to Greece and beyond ‚ù§Ô∏è</div>

  <div id="airplane">‚úàÔ∏è</div>

  <div id="infoCard" class="card"></div>
  <div class="nav-buttons">
    <button id="prevBtn" style="display:none;">‚¨Ö Previous</button>
    <button id="nextBtn" style="display:none;">Next ‚û°</button>
    <button id="endBtn" style="display:none;">End üéâ</button>
    <button id="startBtn" class="pulsing">Start ‚úàÔ∏è</button>
  </div>

  <script src="https://unpkg.com/globe.gl"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    // Animated dots
    setInterval(() => {
      const dots = document.getElementById('dots');
      dots.textContent = dots.textContent.length >= 3 ? '' : dots.textContent + '.';
    }, 500);

    // Simulate loading
    let load = 0;
    const bar = document.getElementById('loadingBar');
    const perc = document.getElementById('loadingPercentage');
    const contText = document.getElementById('continueText');
    const interval = setInterval(() => {
      if (load < 100) {
        load++;
        bar.style.width = load + '%';
        perc.textContent = load + '%';
      } else {
        clearInterval(interval);
        contText.style.opacity = 1;
        contText.classList.add('pulsating-vibrating');
      }
    }, 30);

    document.addEventListener('keydown', e => {
      if (e.key === 'Enter' && load >= 100) document.getElementById('loadingScreen').style.display = 'none';
    });
    document.addEventListener('click', () => {
      if (load >= 100) document.getElementById('loadingScreen').style.display = 'none';
    });

    setInterval(() => {
      confetti({ particleCount: 80, spread: 120, origin: { y: Math.random(), x: Math.random() }, zIndex: 0 });
    }, 1500);

    const elem = document.getElementById('globeViz');
    const card = document.getElementById('infoCard');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const endBtn = document.getElementById('endBtn');
    const startBtn = document.getElementById('startBtn');
    const airplane = document.getElementById('airplane');

    // Keep your original coordinates exactly:
    const places = [
      { lat: 25.5, lng: 20.5, name: "Turkey", message: "We first crossed paths here ‚Äî two lives meeting in the middle of a busy world. I didn‚Äôt know it then, but that moment was the start of something extraordinary.", imgs: ["image1.jpg","image1b.jpg"] },
      { lat: 28.0, lng: 44.0, name: "Azerbaijan", message: "You returned home, and I went my way‚Ä¶ but the distance never truly kept us apart. Every day we spoke, every day we laughed, and with every word our connection grew stronger.", imgs: ["image2.jpg","image2b.jpg","image2c.jpg","image2d.jpg","image2e.jpg"] },
      { lat: 25.0, lng: 15.5, name: "Greece", message: "Then you came to visit, and we turned days into memories. We made a small life in a few days: late walks, salty hair, soft sunsets. Greece felt like home because you were there.", imgs: ["image3.jpg","image3b.jpg","image3c.jpg","image3d.jpg","image3e.jpg","image3f.jpg","image3g.jpg","image3h.jpg","image3i.jpg"] },
      { lat: 49.5, lng: 5.0, name: "Sweden", message: "Now, our eyes are set on a new horizon ‚Äî a place to start fresh, to dream bigger, and to build a life together one step at a time.", imgs: ["image4.jpg","image4b.jpg"] },
      { lat: 55.0, lng: -29.5, name: "Iceland", message: "And one day soon, we‚Äôll stand here, surrounded by the colors of the northern sky, living out a dream we‚Äôve carried in our hearts all along", imgs: ["image5.jpg","image5b.jpg"] }
    ];

    let currentIndex = -1;
    let slideshowTimer = null;

    const world = Globe()(elem)
      .globeImageUrl('earth-cartoon.png')
      .bumpImageUrl(null)
      .backgroundColor('rgba(0,0,0,0)')
      .pointOfView({ lat: 20, lng: 0, altitude: 2 }, 0)
      .labelsData(places)
      .labelLat(d => d.lat)
      .labelLng(d => d.lng)
      .labelText(d => d.name)
      .labelSize(1)
      .labelDotRadius(0.65)
      .labelColor(() => 'white')
      // start with no arcs; we'll add them progressively
      .arcsData([])
      .arcColor(() => ['#2fbf9b', '#ffffff'])
      .arcAltitude(() => 0.12)
      .arcStroke(0.6)
      .arcDashLength(0.5)
      .arcDashGap(0.01)
      .arcDashAnimateTime(2000);

    // Keep globe stationary (no autorotation)
    world.controls().autoRotate = false;
    world.controls().autoRotateSpeed = 0;

    // üîß Use same DOWN offset across devices
    function getLatDownOffset() { return 8; }

    /* Position the card so its BOTTOM edge sits just above the pin */
    function positionCardAbovePin(place, gap = 10) {
      const coords = world.getScreenCoords(place.lat, place.lng);
      if (!coords) return;

      if (card.style.display === 'none') card.style.display = 'block';

      const h = card.offsetHeight || 0;
      card.style.left = coords.x + 'px';
      card.style.top  = (coords.y - h - gap) + 'px';
      card.style.transform = 'translateX(-50%)';
    }

    function revealCard() {
      card.style.visibility = 'visible';
    }

    // Clamp desktop card height so it doesn't overlap title
    function clampCardMaxHeightToTitle() {
      const isMobile = window.matchMedia('(max-width: 600px)').matches;
      if (isMobile) return;
      const title = document.querySelector('.title');
      const rect = title.getBoundingClientRect();
      const safeGap = 20;
      const avail = Math.max(160, window.innerHeight - rect.bottom - safeGap);
      card.style.maxHeight = avail + 'px';
      card.style.overflowY = 'auto';
    }

    // Equalize mobile card height but do NOT shrink slideshow below 180px
    function normalizeCardHeightMobile() {
      const isMobile = window.matchMedia('(max-width: 600px)').matches;
      if (!isMobile) return;
      const target = 330; // keep original target; arrows moved onto image give space
      document.documentElement.style.setProperty('--card-target-height', target + 'px');
      const slideshow = card.querySelector('.slideshow');
      if (!slideshow) return;
      const totalNow = card.offsetHeight;
      const otherHeight = totalNow - slideshow.offsetHeight;
      const desiredSlideH = Math.max(180, target - otherHeight); // never below 180
      slideshow.style.height = desiredSlideH + 'px';
    }

    // --- Progressive arcs ---
    function arcsUpTo(index) {
      // index refers to current place index; arcs up to index are from 0->1, 1->2, ..., (index-1)->index
      if (index <= 0) return [];
      const arcs = [];
      for (let i = 0; i < index; i++) {
        arcs.push({
          startLat: places[i].lat, startLng: places[i].lng,
          endLat: places[i + 1].lat, endLng: places[i + 1].lng
        });
      }
      return arcs;
    }
    function updateArcsForIndex(index) {
      world.arcsData(arcsUpTo(index));
    }

    // Smooth flight + parallel POV; plane can be slower than POV
    function flyPlaneTo(lat, lng, callback, offsetX = -40, offsetY = -10, planeDurationMs = 2400, povDurationMs = 1200) {
      // Start globe POV animation
      const latOffset = getLatDownOffset();
      world.pointOfView({
        lat: parseFloat(lat) + latOffset,
        lng: parseFloat(lng),
        altitude: 0.8
      }, povDurationMs);

      // Plane setup
      airplane.style.display = 'block';
      let startX = airplane.offsetLeft || 0;
      let startY = airplane.offsetTop || 0;

      const ease = t => t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t + 2, 3)/2;
      const arcHeight = 50;

      let startTs = null;
      function step(ts) {
        if (!startTs) startTs = ts;
        const p = Math.min(1, (ts - startTs) / planeDurationMs);
        const t = ease(p);

        const c = world.getScreenCoords(lat, lng);
        if (!c) { requestAnimationFrame(step); return; }

        const targetX = c.x + offsetX;
        const targetY = c.y + offsetY;

        const x = startX + (targetX - startX) * t;
        const yLinear = startY + (targetY - startY) * t;
        const y = yLinear - Math.sin(Math.PI * t) * arcHeight;

        const angle = Math.atan2(y - (airplane.offsetTop || 0), x - (airplane.offsetLeft || 0)) * 180 / Math.PI;

        airplane.style.left = x + 'px';
        airplane.style.top  = y + 'px';
        airplane.style.transform = `rotate(${angle}deg)`;

        if (p < 1) {
          requestAnimationFrame(step);
        } else {
          airplane.style.left = targetX + 'px';
          airplane.style.top  = targetY + 'px';
          airplane.style.transform = 'rotate(0deg)';
          if (callback) callback();
        }
      }
      requestAnimationFrame(step);
    }

    // Build + run slideshow for the current place
    function updateCard(index, revealAfterMs = 1200) {
      const place = places[index];

      const slidesHtml = place.imgs.map((src, i) =>
        `<img class="slide ${i === 0 ? 'active' : ''}" src="${src}" alt="${place.name} photo ${i+1}">`
      ).join('');

      const dotsHtml = place.imgs.map((_, i) =>
        `<span class="dot ${i === 0 ? 'active' : ''}" data-idx="${i}"></span>`
      ).join('');

      card.style.display = 'block';
      card.style.visibility = 'hidden';
      card.innerHTML = `
        <div class="slideshow" aria-label="${place.name} photos (slideshow)">
          ${slidesHtml}
          <button class="arrow-btn arrow-left" aria-label="Previous image">‚Äπ</button>
          <button class="arrow-btn arrow-right" aria-label="Next image">‚Ä∫</button>
        </div>
        <div class="slide-controls">
          <div class="dots">${dotsHtml}</div>
        </div>
        <p>${place.message}</p>
      `;

      // Wire up slideshow controls
      let imgIdx = 0;
      const slides = card.querySelectorAll('.slide');
      const dots = card.querySelectorAll('.dot');
      const prev = card.querySelector('.arrow-left');
      const next = card.querySelector('.arrow-right');
      const slideshowEl = card.querySelector('.slideshow');

      function show(n) {
        imgIdx = (n + slides.length) % slides.length;
        slides.forEach((el, i) => el.classList.toggle('active', i === imgIdx));
        dots.forEach((el, i) => el.classList.toggle('active', i === imgIdx));
        positionCardAbovePin(place);
      }

      const stop = e => { e.stopPropagation(); };
      prev.addEventListener('click', (e) => { stop(e); show(imgIdx - 1); });
      next.addEventListener('click', (e) => { stop(e); show(imgIdx + 1); });
      slideshowEl.addEventListener('click', (e) => { stop(e); show(imgIdx + 1); });

      let startX = null;
      slideshowEl.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; }, { passive: true });
      slideshowEl.addEventListener('touchend', (e) => {
        if (startX == null) return;
        const dx = e.changedTouches[0].clientX - startX;
        if (Math.abs(dx) > 30) show(imgIdx + (dx < 0 ? 1 : -1));
        startX = null;
        e.stopPropagation();
      }, { passive: true });

      dots.forEach(d => d.addEventListener('click', (e) => { e.stopPropagation(); show(parseInt(d.dataset.idx)); }));

      prevBtn.style.display = index > 0 ? 'inline-block' : 'none';
      nextBtn.style.display = index < places.length - 1 ? 'inline-block' : 'none';
      endBtn.style.display = index === places.length - 1 ? 'inline-block' : 'none';

      normalizeCardHeightMobile();
      clampCardMaxHeightToTitle();

      setTimeout(() => {
        positionCardAbovePin(place);
        revealCard();
      }, revealAfterMs + 50);
    }

    /* ========= Reset to initial post-loading state ========= */
    function resetApp() {
      if (slideshowTimer) clearInterval(slideshowTimer);

      currentIndex = -1;

      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      endBtn.style.display = 'none';
      startBtn.style.display = 'inline-block';
      startBtn.disabled = false;
      startBtn.classList.add('pulsing');

      card.style.display = 'none';
      card.style.visibility = 'hidden';
      card.innerHTML = '';

      world.pointOfView({ lat: 20, lng: 0, altitude: 2 }, 0);

      // clear arcs and plane
      world.arcsData([]);
      airplane.style.display = 'none';
      airplane.style.left = '0px';
      airplane.style.top = '0px';
      airplane.style.transform = 'rotate(0deg)';

      clampCardMaxHeightToTitle();
    }
    /* ============================================================= */

    // START
    startBtn.addEventListener('click', () => {
      startBtn.classList.remove('pulsing');
      startBtn.disabled = true;
      currentIndex = 0;

      card.style.display = 'none';
      card.style.visibility = 'hidden';

      const planeDur = 3000; // slower plane
      const povDur   = 2000; // faster POV so card shows sooner
      flyPlaneTo(places[0].lat, places[0].lng, () => {
        updateCard(0, povDur);
        updateArcsForIndex(0); // no arcs yet at the first stop
        nextBtn.style.display = 'inline-block';
        startBtn.style.display = 'none';
      }, -40, -10, planeDur, povDur);
    });

    // NEXT
    nextBtn.addEventListener('click', () => {
      if (currentIndex < places.length - 1) {
        nextBtn.disabled = true;
        currentIndex++;

        card.style.display = 'none';
        card.style.visibility = 'hidden';

        const dest = places[currentIndex];
        const planeDur = 2400;
        const povDur   = 1200;
        flyPlaneTo(dest.lat, dest.lng, () => {
          updateCard(currentIndex, povDur);
          updateArcsForIndex(currentIndex); // cumulatively show arcs up to this point
          nextBtn.disabled = false;
        }, -40, -10, planeDur, povDur);
      }
    });

    // PREV
    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        prevBtn.disabled = true;
        currentIndex--;

        card.style.display = 'none';
        card.style.visibility = 'hidden';

        const dest = places[currentIndex];
        const planeDur = 2400;
        const povDur   = 1200;
        flyPlaneTo(dest.lat, dest.lng, () => {
          updateCard(currentIndex, povDur);
          updateArcsForIndex(currentIndex); // remove later arcs when going back
          prevBtn.disabled = false;
        }, -40, -10, planeDur, povDur);
      }
    });

    // END (modified to include Refresh button)
    endBtn.addEventListener('click', () => {
      if (slideshowTimer) clearInterval(slideshowTimer);
      card.innerHTML = `
        <h2>üéâ Happy Birthday! üéâ</h2>
        <p>And through it all, one truth remains ‚Äî you are my favorite story, my greatest adventure, and my happiest place. Happy 25th birthday, omorfia mou. Here‚Äôs to all the journeys still ahead. ‚ù§Ô∏è</p>
        <button id="refreshLastBtn" class="refresh-btn">Refresh üîÑ</button>
      `;
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      endBtn.style.display = 'none';
      positionCardAbovePin(places[currentIndex]);
      revealCard();

      // wire up Refresh
      const refreshLastBtn = document.getElementById('refreshLastBtn');
      refreshLastBtn.addEventListener('click', resetApp);
    });

    // Reposition card and re-apply sizing on window resize
    window.addEventListener('resize', () => {
      if (currentIndex >= 0) {
        normalizeCardHeightMobile();
        clampCardMaxHeightToTitle();
        positionCardAbovePin(places[currentIndex]);
      }
    });
  </script>
</body>
</html>
