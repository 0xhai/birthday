<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Happy Birthday name üéâ</title>

  <!-- Fonts & perf -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg1: #dff5ee;
      --bg2: #a7ded0;
      --brand: #2fbf9b;
      --safe-gap: 20px;
      --vh: 1vh; /* fallback for iOS pre-dvh */
    }

    html,
    body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: linear-gradient(to bottom right, var(--bg1), var(--bg2));
    }

    /* Improve mobile vh correctness on modern browsers */
    @supports (height: 100dvh) {
      #globeViz {
        height: 100dvh;
      }
      canvas.confetti-canvas {
        height: 100dvh !important;
      }
    }

    /* Loader */
    #loadingScreen {
      position: fixed;
      inset: 0;
      background: linear-gradient(to bottom right, var(--bg1), var(--bg2));
      display: grid;
      place-content: center;
      gap: 16px;
      z-index: 10;
      color: #fff;
      font-family: 'Pacifico', cursive;
      text-align: center;
      padding: 24px;
    }

    .ml11 {
      font-weight: 500;
      font-size: clamp(2rem, 4vw, 3rem);
      white-space: nowrap;
      overflow: hidden;
    }

    .loading-bar-container {
      width: min(350px, 85vw);
      height: 28px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      margin: 6px auto 0;
      position: relative;
    }

    .loading-bar {
      height: 100%;
      width: 0%;
      background: var(--brand);
      transition: width 0.2s linear;
    }

    .loading-percentage {
      font-size: clamp(20px, 3vw, 26px);
      font-family: 'Pacifico', cursive;
    }

    .continue-text {
      opacity: 0;
      margin-top: 6px;
      font-size: clamp(18px, 3vw, 26px);
      font-family: 'Pacifico', cursive;
      transition: opacity 0.5s;
    }

    /* Titles */
    .title {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      font-family: 'Pacifico', cursive;
      font-size: clamp(2.2rem, 5vw, 4rem);
      color: #fff;
      text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
      z-index: 5;
      padding: 0 12px;
      box-sizing: border-box;
    }

    .subtitle {
      position: absolute;
      bottom: max(20px, env(safe-area-inset-bottom));
      width: 100%;
      text-align: center;
      font-family: 'Pacifico', cursive;
      font-size: clamp(1.1rem, 3vw, 2.2rem);
      color: #fff;
      text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
      z-index: 5;
      padding: 0 12px;
      box-sizing: border-box;
    }

    #globeViz {
      width: 100vw;
      height: calc(var(--vh) * 100);
      position: relative;
      z-index: 1;
    }

    .popup {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 15px 20px;
      border-radius: 10px;
      font-family: 'Pacifico', cursive;
      font-size: 18px;
      display: none;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
    }

    .card {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 16px 22px;
      border-radius: 12px;
      text-align: center;
      width: 820px;
      max-height: none;
      overflow-y: visible;
      z-index: 5;
      display: none;
      visibility: hidden;
      font-family: 'Pacifico', cursive;
      font-size: clamp(18px, 1.15vw, 24px);
      box-shadow: 0 8px 24px rgba(0,0,0,.15);
    }

    .nav-buttons {
      position: absolute;
      bottom: 80px;
      width: 100%;
      text-align: center;
      z-index: 6;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      padding: 0 10px;
      box-sizing: border-box;
    }

    .nav-buttons button {
      padding: clamp(10px, 3vw, 20px) clamp(16px, 4vw, 40px);
      font-size: clamp(22px, 4vw, 36px);
      cursor: pointer;
      border: none;
      background: var(--brand);
      color: white;
      border-radius: 12px;
      font-family: 'Pacifico', cursive;
      transition: transform 0.06s ease, opacity 0.3s;
      touch-action: manipulation;
    }
    .nav-buttons button:active { transform: translateY(1px) scale(.99); }
    .nav-buttons button:disabled { opacity: .5; cursor: not-allowed; }

    #skipAnimBtn {
      background: #1c9b7f;
      font-size: clamp(16px, 3vw, 20px);
      padding: 8px 16px;
      border-radius: 999px;
    }

    #airplane {
      position: absolute;
      font-size: clamp(50px, 8vw, 100px);
      z-index: 9999;
      transition: transform 1s linear;
      display: none;
      will-change: transform, left, top;
      user-select: none;
      pointer-events: none;
    }

    canvas.confetti-canvas {
      position: fixed !important;
      inset: 0 !important;
      width: 100vw !important;
      height: calc(var(--vh) * 100) !important;
      z-index: 0 !important;
      pointer-events: none;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(47,191,155,.7) }
      70% { box-shadow: 0 0 0 15px rgba(47,191,155,0) }
      100% { box-shadow: 0 0 0 0 rgba(47,191,155,0) }
    }
    .pulsing { animation: pulse 2s infinite; }

    @keyframes pulseFade {
      0%,100% { opacity:.5; transform:scale(1) }
      50% { opacity:1; transform:scale(1.05) }
    }
    @keyframes vibrate {
      0% { transform: translateX(0) }
      20% { transform: translateX(-1px) }
      40% { transform: translateX(1px) }
      60% { transform: translateX(-1px) }
      80% { transform: translateX(2px) }
      100% { transform: translateX(0) }
    }
    .pulsating-vibrating { animation: pulseFade 1.5s infinite ease-in-out, vibrate 1s infinite linear; }

    /* Slideshow */
    .slideshow { position: relative; width: 100%; height: 260px; overflow: hidden; border-radius: 10px; background: #fff; }
    .slideshow .slide { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; object-position: center; opacity: 0; transition: opacity .5s ease; background: #fff; }
    .slideshow .slide.active { opacity: 1; }

    .arrow-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(47, 191, 155, 0.9);
      color: #fff;
      border: none;
      border-radius: 999px;
      width: 36px;
      height: 36px;
      line-height: 36px;
      text-align: center;
      font-family: 'Pacifico', cursive;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      user-select: none;
    }
    .arrow-left { left: 8px; }
    .arrow-right { right: 8px; }

    .slide-controls { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 6px; }
    .dots { display: flex; gap: 6px; align-items: center; justify-content: center; }
    .dot { width: 9px; height: 9px; border-radius: 50%; background: #d7f3ea; display: inline-block; cursor: pointer; }
    .dot.active { background: var(--brand); }

    /* Mobile */
    @media (max-width: 600px) {
      .ml11 { font-size: 1.4rem; }
      .loading-bar-container { height: 20px; width: 85%; }
      .loading-percentage, .continue-text { font-size: 18px; }
      .title { font-size: 1.6rem; }
      .subtitle { font-size: 1rem; }

      .card {
        width: min(95vw, 420px);
        padding: 10px 12px;
        font-size: clamp(14px, 4vw, 18px);
        height: var(--card-target-height, 340px);
        max-height: var(--card-target-height, 340px);
        overflow-y: hidden;
      }
      .slideshow { height: 180px; }
      .card img {
        display: block;
        width: 100%;
        height: auto;
        object-fit: cover;
        border-radius: 6px;
      }
      .card p { margin: 8px 0 0; line-height: 1.25; }
    }

    /* Accessible focus (keep outlines) */
    button:focus-visible, .arrow-btn:focus-visible, .dot:focus-visible {
      outline: 3px solid #0e6c57;
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div id="loadingScreen" role="dialog" aria-modal="true" aria-live="polite">
    <div class="ml11">
      <span class="letters">Preparing your surprise3<span id="dots">...</span></span>
    </div>
    <div class="loading-bar-container" aria-label="Loading progress">
      <div class="loading-bar" id="loadingBar"></div>
    </div>
    <div class="loading-percentage" id="loadingPercentage" aria-live="polite">0%</div>
    <div class="continue-text" id="continueText">[Press ENTER or Tap to continue]</div>
    <div>
      <button id="skipAnimBtn" type="button" aria-pressed="false">Skip animations</button>
    </div>
  </div>

  <div class="title" id="titleText">üéÇ Happy Birthday name üéÇ</div>
  <div id="globeViz" aria-label="3D globe visualization"></div>
  <div id="popup" class="popup" role="status"></div>
  <div class="subtitle" id="subtitleText">From country1 to country2, to country3... and beyond ‚ù§Ô∏è</div>

  <div id="airplane" aria-hidden="true">‚úàÔ∏è</div>

  <div id="infoCard" class="card" aria-live="polite"></div>
  <div class="nav-buttons">
    <button id="prevBtn" type="button" style="display:none;">‚¨Ö Previous</button>
    <button id="nextBtn" type="button" style="display:none;">Next ‚û°</button>
    <button id="endBtn"  type="button" style="display:none;">End üéâ</button>
    <button id="startBtn" type="button" class="pulsing">Start ‚úàÔ∏è</button>
  </div>

  <script src="https://unpkg.com/globe.gl"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    // --- Utility: fix mobile 100vh on iOS ---
    function setVH() {
      document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px');
    }
    setVH();
    window.addEventListener('resize', setVH);

    // --- Personalization ---
    const PERSON_NAME = 'name';
    const FROM_TO = ['country1', 'country2', 'country3'];
    document.title = `Happy Birthday ${PERSON_NAME} üéâ`;
    document.getElementById('titleText').textContent = `üéÇ Happy Birthday ${PERSON_NAME} üéÇ`;
    document.getElementById('subtitleText').textContent = `From ${FROM_TO.join(' to ')}, and beyond ‚ù§Ô∏è`;

    // --- Reduced motion handling (user toggle & media query) ---
    const reduceMotionMedia = window.matchMedia('(prefers-reduced-motion: reduce)');
    const storedReduce = localStorage.getItem('hb_reduce_motion');
    let reduceMotion = storedReduce ? storedReduce === '1' : reduceMotionMedia.matches;

    const skipBtn = document.getElementById('skipAnimBtn');
    skipBtn.setAttribute('aria-pressed', String(reduceMotion));
    skipBtn.textContent = reduceMotion ? 'Enable animations' : 'Skip animations';
    skipBtn.addEventListener('click', () => {
      reduceMotion = !reduceMotion;
      localStorage.setItem('hb_reduce_motion', reduceMotion ? '1' : '0');
      skipBtn.setAttribute('aria-pressed', String(reduceMotion));
      skipBtn.textContent = reduceMotion ? 'Enable animations' : 'Skip animations';
    });

    // Animated dots on loader
    setInterval(() => {
      const dots = document.getElementById('dots');
      dots.textContent = dots.textContent.length >= 3 ? '' : dots.textContent + '.';
    }, 500);

    const loadingScreen = document.getElementById('loadingScreen');
    const bar = document.getElementById('loadingBar');
    const perc = document.getElementById('loadingPercentage');
    const contText = document.getElementById('continueText');

    // --- Places (coords corrected for countries) ---
    const places = [
      { lat: 39.0, lng: 35.0, name: "Turkey", message: "We first crossed paths here ‚Äî two lives meeting in the middle of a busy world. I didn‚Äôt know it then, but that moment was the start of something extraordinary.", imgs: ["image1.jpg","image1b.jpg"] },
      { lat: 40.3, lng: 47.7, name: "Azerbaijan", message: "You returned home, and I went my way‚Ä¶ but the distance never truly kept us apart. Every day we spoke, every day we laughed, and with every word our connection grew stronger.", imgs: ["image2.jpg","image2b.jpg","image2c.jpg","image2d.jpg"] },
      { lat: 38.0, lng: 23.7, name: "Greece", message: "Then you came to visit, and we turned days into memories. From sunlit streets to quiet moments by the sea, Greece became our playground of joy.", imgs: ["image3.jpg","image3b.jpg","image3c.jpg","image3d.jpg","image3e.jpg","image3f.jpg","image3g.jpg","image3h.jpg","image3i.jpg"] },
      { lat: 60.1, lng: 18.6, name: "Sweden", message: "Now, our eyes are set on a new horizon ‚Äî a place to start fresh, to dream bigger, and to build a life together one step at a time.", imgs: ["image4.jpg","image4b.jpg"] },
      { lat: 64.9, lng: -19.0, name: "Iceland", message: "And one day soon, we‚Äôll stand here, surrounded by the colors of the northern sky, living out a dream we‚Äôve carried in our hearts all along.", imgs: ["image5.jpg","image5b.jpg"] }
    ];

    // --- Confetti control (pause on hidden tab & if reduced motion) ---
    let confettiTimer = null;
    function startConfetti() {
      if (reduceMotion) return;
      stopConfetti();
      confettiTimer = setInterval(() => {
        confetti({
          particleCount: 80,
          spread: 120,
          origin: { y: Math.random(), x: Math.random() },
          zIndex: 0
        });
      }, 1500);
    }
    function stopConfetti() {
      if (confettiTimer) clearInterval(confettiTimer);
      confettiTimer = null;
    }
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopConfetti();
      else startConfetti();
    });

    // --- Asset Preloading (real progress) ---
    function unique(list) { return [...new Set(list)]; }
    const assetList = unique(['earth-cartoon.png', ...places.flatMap(p => p.imgs)]);

    function preloadAssets(urls, onProgress) {
      let done = 0;
      const total = urls.length || 1;
      const loadOne = (u) =>
        new Promise((res) => {
          const i = new Image();
          i.onload = i.onerror = () => {
            done++;
            onProgress(Math.round((done / total) * 100));
            res();
          };
          i.decoding = 'async';
          i.loading = 'eager';
          i.src = u;
        });
      return Promise.all(urls.map(loadOne));
    }

    let loaderFinished = false;
    function setProgress(v) {
      bar.style.width = v + '%';
      perc.textContent = v + '%';
    }

    // Allow "skip loader" on repeat visits
    const HAS_SEEN_KEY = 'hb_has_seen';
    const hasSeen = localStorage.getItem(HAS_SEEN_KEY) === '1';

    (async function initLoader() {
      if (!hasSeen) {
        await preloadAssets(assetList, setProgress);
        loaderFinished = true;
        contText.style.opacity = 1;
        contText.classList.add('pulsating-vibrating');
      } else {
        // Quick show 100% and allow immediate continue
        setProgress(100);
        loaderFinished = true;
        contText.style.opacity = 1;
      }
    })();

    function maybeHideLoader() {
      if (!loaderFinished) return;
      loadingScreen.style.display = 'none';
      localStorage.setItem(HAS_SEEN_KEY, '1');
      startConfetti();
      // Move focus to Start for keyboard users
      document.getElementById('startBtn').focus();
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && loaderFinished) maybeHideLoader();
    });
    document.addEventListener('click', () => {
      if (loaderFinished) maybeHideLoader();
    });

    // --- Globe setup ---
    const elem = document.getElementById('globeViz');
    const card = document.getElementById('infoCard');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const endBtn = document.getElementById('endBtn');
    const startBtn = document.getElementById('startBtn');
    const airplane = document.getElementById('airplane');

    const world = Globe()(elem)
      .globeImageUrl('earth-cartoon.png')
      .bumpImageUrl(null)
      .backgroundColor('rgba(0,0,0,0)')
      .pointOfView({ lat: 20, lng: 0, altitude: 2 }, 0)
      .labelsData(places)
      .labelLat(d => d.lat)
      .labelLng(d => d.lng)
      .labelText(d => d.name)
      .labelSize(1)
      .labelDotRadius(0.65)
      .labelColor(() => 'white')
      .atmosphereColor('#9fe3d2')
      .atmosphereAltitude(0.18)
      .enablePointerInteraction(true);

    // gentle autorotate, pause on interaction
    world.controls().autoRotate = true;
    world.controls().autoRotateSpeed = 0.25;
    world.controls().addEventListener('start', () => { world.controls().autoRotate = false; });
    world.controls().addEventListener('end', () => { world.controls().autoRotate = true; });

    // arcs for the journey
    const arcs = places.slice(0, -1).map((p, i) => ({
      startLat: p.lat, startLng: p.lng,
      endLat: places[i + 1].lat, endLng: places[i + 1].lng
    }));
    world
      .arcsData(arcs)
      .arcColor(() => ['#2fbf9b', '#ffffff'])
      .arcAltitude(() => 0.12)
      .arcStroke(0.6)
      .arcDashLength(0.5)
      .arcDashGap(0.01)
      .arcDashInitialGap(2)
      .arcDashAnimateTime(reduceMotion ? 0 : 2000);

    // --- Sizing helpers ---
    function clampCardMaxHeightToTitle() {
      const isMobile = window.matchMedia('(max-width: 600px)').matches;
      if (isMobile) return;
      const title = document.querySelector('.title');
      const rect = title.getBoundingClientRect();
      const safeGap = 20;
      const avail = Math.max(160, window.innerHeight - rect.bottom - safeGap);
      card.style.maxHeight = avail + 'px';
      card.style.overflowY = 'auto';
    }

    function normalizeCardHeightMobile() {
      const isMobile = window.matchMedia('(max-width: 600px)').matches;
      if (!isMobile) return;
      const target = 330;
      document.documentElement.style.setProperty('--card-target-height', target + 'px');
      const slideshow = card.querySelector('.slideshow');
      if (!slideshow) return;
      const totalNow = card.offsetHeight;
      const otherHeight = totalNow - slideshow.offsetHeight;
      const desiredSlideH = Math.max(180, target - otherHeight);
      slideshow.style.height = desiredSlideH + 'px';
    }

    function getLatDownOffset() { return 8; }

    // Positioning that retries until coords are ready
    function positionCardAbovePin(place, gap = 10) {
      const tryPos = () => {
        const coords = world.getScreenCoords(place.lat, place.lng);
        if (!coords) { requestAnimationFrame(tryPos); return; }
        if (card.style.display === 'none') card.style.display = 'block';
        const h = card.offsetHeight || 0;
        card.style.left = coords.x + 'px';
        card.style.top  = (coords.y - h - gap) + 'px';
        card.style.transform = 'translateX(-50%)';
      };
      tryPos();
    }

    function revealCard() { card.style.visibility = 'visible'; card.tabIndex = 0; }

    // --- Airplane animation (robust start) ---
    let planePos = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    function flyPlaneTo(lat, lng, callback, offsetX = -40, offsetY = -10, planeDurationMs = 2400, povDurationMs = 1200) {
      if (reduceMotion) { planeDurationMs = 0; povDurationMs = 0; }

      // Start globe POV animation
      const latOffset = getLatDownOffset();
      world.pointOfView({ lat: parseFloat(lat) + latOffset, lng: parseFloat(lng), altitude: 0.8 }, povDurationMs);

      // Plane setup
      airplane.style.display = reduceMotion ? 'none' : 'block';

      let startX = planePos.x;
      let startY = planePos.y;

      const ease = t => t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
      const arcHeight = 50;

      let startTs = null;
      function step(ts) {
        if (!startTs) startTs = ts;
        const p = planeDurationMs ? Math.min(1, (ts - startTs) / planeDurationMs) : 1;
        const t = ease(p);

        const c = world.getScreenCoords(lat, lng);
        if (!c) { requestAnimationFrame(step); return; }

        const targetX = c.x + offsetX;
        const targetY = c.y + offsetY;

        const x = startX + (targetX - startX) * t;
        const yLinear = startY + (targetY - startY) * t;
        const y = yLinear - Math.sin(Math.PI * t) * arcHeight;

        const dx = x - (parseFloat(airplane.style.left) || startX);
        const dy = y - (parseFloat(airplane.style.top)  || startY);
        const angle = Math.atan2(dy, dx) * 180 / Math.PI;

        airplane.style.left = x + 'px';
        airplane.style.top  = y + 'px';
        airplane.style.transform = `rotate(${angle}deg)`;

        if (p < 1) {
          requestAnimationFrame(step);
        } else {
          airplane.style.left = targetX + 'px';
          airplane.style.top  = targetY + 'px';
          airplane.style.transform = 'rotate(0deg)';
          planePos = { x: targetX, y: targetY };
          if (callback) callback();
        }
      }
      requestAnimationFrame(step);
    }

    // --- Slideshow / card builder ---
    let currentIndex = -1;
    let slideshowTimer = null;
    function clearSlideTimer(){ if (slideshowTimer) { clearInterval(slideshowTimer); slideshowTimer = null; } }

    function updateCard(index, revealAfterMs = 1200) {
      const place = places[index];

      const slidesHtml = place.imgs.map((src, i) =>
        `<img class="slide ${i === 0 ? 'active' : ''}" src="${src}" alt="${place.name} photo ${i + 1}"
              loading="${i === 0 ? 'eager' : 'lazy'}" decoding="async">`
      ).join('');

      const dotsHtml = place.imgs.map((_, i) =>
        `<span class="dot ${i === 0 ? 'active' : ''}" role="button" tabindex="0" aria-label="Go to image ${i + 1}" data-idx="${i}"></span>`
      ).join('');

      card.style.display = 'block';
      card.style.visibility = 'hidden';
      card.innerHTML = `
        <div class="slideshow" aria-label="${place.name} photos (slideshow)">
          ${slidesHtml}
          <button class="arrow-btn arrow-left" type="button" aria-label="Previous image">‚Äπ</button>
          <button class="arrow-btn arrow-right" type="button" aria-label="Next image">‚Ä∫</button>
        </div>
        <div class="slide-controls">
          <div class="dots">${dotsHtml}</div>
        </div>
        <p>${place.message}</p>
      `;

      let imgIdx = 0;
      const slides = card.querySelectorAll('.slide');
      const dots = card.querySelectorAll('.dot');
      const prev = card.querySelector('.arrow-left');
      const next = card.querySelector('.arrow-right');
      const slideshowEl = card.querySelector('.slideshow');

      function show(n) {
        imgIdx = (n + slides.length) % slides.length;
        slides.forEach((el, i) => el.classList.toggle('active', i === imgIdx));
        dots.forEach((el, i) => el.classList.toggle('active', i === imgIdx));
        positionCardAbovePin(place);
      }

      const stop = e => { e.stopPropagation(); };

      prev.addEventListener('click', (e) => { stop(e); show(imgIdx - 1); });
      next.addEventListener('click', (e) => { stop(e); show(imgIdx + 1); });
      slideshowEl.addEventListener('click', (e) => { stop(e); show(imgIdx + 1); });

      // Swipe on touch
      let startX = null;
      slideshowEl.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; }, { passive: true });
      slideshowEl.addEventListener('touchend', (e) => {
        if (startX == null) return;
        const dx = e.changedTouches[0].clientX - startX;
        if (Math.abs(dx) > 30) show(imgIdx + (dx < 0 ? 1 : -1));
        startX = null;
        e.stopPropagation();
      }, { passive: true });

      // Dots (click & keyboard)
      dots.forEach(d => {
        d.addEventListener('click', (e) => { e.stopPropagation(); show(parseInt(d.dataset.idx)); });
        d.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); show(parseInt(d.dataset.idx)); }
        });
      });

      // Keyboard arrows for the whole card
      card.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft')  { e.preventDefault(); prev.click(); }
        if (e.key === 'ArrowRight') { e.preventDefault(); next.click(); }
      });

      prevBtn.style.display = index > 0 ? 'inline-block' : 'none';
      nextBtn.style.display = index < places.length - 1 ? 'inline-block' : 'none';
      endBtn.style.display = index === places.length - 1 ? 'inline-block' : 'none';

      normalizeCardHeightMobile();
      clampCardMaxHeightToTitle();

      // Reveal after POV finishes (plane can keep flying)
      setTimeout(() => {
        positionCardAbovePin(place);
        revealCard();
      }, revealAfterMs + 50);
    }

    // Reset to initial state
    function resetApp() {
      clearSlideTimer();
      currentIndex = -1;

      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      endBtn.style.display = 'none';
      startBtn.style.display = 'inline-block';
      startBtn.disabled = false;
      startBtn.classList.add('pulsing');

      card.style.display = 'none';
      card.style.visibility = 'hidden';
      card.innerHTML = '';

      world.pointOfView({ lat: 20, lng: 0, altitude: 2 }, 0);

      airplane.style.display = 'none';
      airplane.style.left = '0px';
      airplane.style.top = '0px';
      airplane.style.transform = 'rotate(0deg)';
      planePos = { x: window.innerWidth / 2, y: window.innerHeight / 2 };

      clampCardMaxHeightToTitle();
    }

    // START
    startBtn.addEventListener('click', () => {
      startBtn.classList.remove('pulsing');
      startBtn.disabled = true;
      currentIndex = 0;

      card.style.display = 'none';
      card.style.visibility = 'hidden';

      const planeDur = reduceMotion ? 0 : 3000;
      const povDur   = reduceMotion ? 0 : 2000;
      flyPlaneTo(places[0].lat, places[0].lng, () => {
        updateCard(0, povDur);
        nextBtn.style.display = 'inline-block';
        startBtn.style.display = 'none';
      }, -40, -10, planeDur, povDur);
    });

    // NEXT
    nextBtn.addEventListener('click', () => {
      clearSlideTimer();
      if (currentIndex < places.length - 1) {
        nextBtn.disabled = true;
        currentIndex++;

        card.style.display = 'none';
        card.style.visibility = 'hidden';

        const dest = places[currentIndex];
        const planeDur = reduceMotion ? 0 : 2400;
        const povDur   = reduceMotion ? 0 : 1200;
        flyPlaneTo(dest.lat, dest.lng, () => {
          updateCard(currentIndex, povDur);
          nextBtn.disabled = false;
        }, -40, -10, planeDur, povDur);
      }
    });

    // PREV
    prevBtn.addEventListener('click', () => {
      clearSlideTimer();
      if (currentIndex > 0) {
        prevBtn.disabled = true;
        currentIndex--;

        card.style.display = 'none';
        card.style.visibility = 'hidden';

        const dest = places[currentIndex];
        const planeDur = reduceMotion ? 0 : 2400;
        const povDur   = reduceMotion ? 0 : 1200;
        flyPlaneTo(dest.lat, dest.lng, () => {
          updateCard(currentIndex, povDur);
          prevBtn.disabled = false;
        }, -40, -10, planeDur, povDur);
      }
    });

    // END (adds Share + Refresh)
    endBtn.addEventListener('click', () => {
      clearSlideTimer();
      const shareHtml = `
        <h2>üéâ Happy Birthday! üéâ</h2>
        <p>And through it all, one truth remains ‚Äî you are my favorite story, my greatest adventure, and my happiest place. Happy 25th birthday, omorfia mou. Here‚Äôs to all the journeys still ahead. ‚ù§Ô∏è</p>
        <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
          <button id="shareBtn" class="refresh-btn" type="button" style="background:#1c9b7f;">Share üì§</button>
          <button id="refreshLastBtn" class="refresh-btn" type="button">Refresh üîÑ</button>
        </div>
      `;
      card.innerHTML = shareHtml;
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      endBtn.style.display = 'none';
      positionCardAbovePin(places[currentIndex]);
      card.style.display = 'block';
      revealCard();

      const shareBtn = document.getElementById('shareBtn');
      if (navigator.share) {
        shareBtn.addEventListener('click', async () => {
          try {
            await navigator.share({
              title: document.title,
              text: `Happy Birthday ${PERSON_NAME}!`,
              url: location.href
            });
          } catch {}
        });
      } else {
        shareBtn.disabled = true;
        shareBtn.textContent = 'Share (unsupported)';
        shareBtn.title = 'Web Share API not supported on this device/browser.';
      }

      document.getElementById('refreshLastBtn').addEventListener('click', resetApp);
    });

    // Reposition card and re-apply sizing on window resize
    window.addEventListener('resize', () => {
      if (currentIndex >= 0) {
        normalizeCardHeightMobile();
        clampCardMaxHeightToTitle();
        positionCardAbovePin(places[currentIndex]);
      }
    });

    // Give Start button focus after DOM settles for a11y if loader was skipped
    if (hasSeen) {
      // allow user to skip without clicking
      setTimeout(() => { loadingScreen.style.display = 'none'; startConfetti(); startBtn.focus(); }, 250);
    }

  </script>
</body>
</html>
