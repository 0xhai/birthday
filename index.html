<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Happy Birthday name üéâ</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <style>
    html, body { 
      margin: 0; 
      height: 100%; 
      overflow: hidden; 
      background: linear-gradient(to bottom right, #ffcccc, #ff99cc); 
    }

    #loadingScreen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(to bottom right, #ffcccc, #ff99cc);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      color: #fff;
      font-family: 'Pacifico', cursive;
    }

    .ml11 {
      font-weight: 500;
      font-size: clamp(2.2rem, 4vw, 3rem);
      white-space: nowrap;
      overflow: hidden;
    }

    .loading-bar-container {
      width: 350px;
      height: 28px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 20px;
      position: relative;
    }

    .loading-bar {
      height: 100%;
      width: 0%;
      background: #ff69b4;
      transition: width 0.2s;
    }

    .loading-percentage {
      margin-top: 5px;
      font-size: 26px;
      font-family: 'Pacifico', cursive;
    }

    .continue-text {
      opacity: 0;
      margin-top: 15px;
      font-size: 26px;
      font-family: 'Pacifico', cursive;
      transition: opacity 0.5s;
    }

    #globeViz { 
      width: 100vw; 
      height: 100vh; 
      position: relative;
      z-index: 1;
    }

    .popup {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 15px 20px;
      border-radius: 10px;
      font-family: 'Pacifico', cursive;
      font-size: 18px;
      display: none;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
    }

    .title {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      font-family: 'Pacifico', cursive;
      font-size: clamp(2.8rem, 5vw, 4rem);
      color: #fff;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.4);
      z-index: 5;
    }

    .subtitle {
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      font-family: 'Pacifico', cursive;
      font-size: clamp(1.5rem, 3vw, 2.5rem);
      color: #fff;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.4);
      z-index: 5;
    }

    /* ===== Desktop default (bigger, but clamped via JS) ===== */
    .card {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.95);
      padding: 16px 22px;
      border-radius: 12px;
      text-align: center;
      width: 820px;                  /* a bit bigger on PC */
      max-height: none;
      overflow-y: visible;
      z-index: 5;
      display: none;                 /* hidden until positioned */
      visibility: hidden;            /* avoid flicker */
      font-family: 'Pacifico', cursive;
      font-size: clamp(18px, 1.15vw, 24px);
    }

    .nav-buttons {
      position: absolute;
      bottom: 80px;
      width: 100%;
      text-align: center;
      z-index: 6;
    }

    .nav-buttons button {
      padding: clamp(10px, 3vw, 20px) clamp(16px, 4vw, 40px);
      font-size: clamp(28px, 4vw, 50px);
      cursor: pointer;
      border: none;
      background: #ff69b4;
      color: white;
      border-radius: 8px;
      margin: 0 10px;
      font-family: 'Pacifico', cursive;
      transition: opacity 0.3s;
    }

    .nav-buttons button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #airplane {
      position: absolute;
      font-size: 100px;
      z-index: 9999;
      transition: transform 1s linear;
      display: block;
    }

    canvas.confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 0 !important;
      pointer-events: none;
    }

    @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(255,105,180,.7)} 70%{box-shadow:0 0 0 15px rgba(255,105,180,0)} 100%{box-shadow:0 0 0 0 rgba(255,105,180,0)} }
    .pulsing { animation: pulse 2s infinite; }

    @media screen and (max-width: 600px) {
      .ml11 { font-size: 1.4rem; }
      .loading-bar-container { height: 20px; width: 85%; }
      .loading-percentage { font-size: 18px; }
      .continue-text { font-size: 18px; }
      .title { font-size: 1.6rem; }
      .subtitle { font-size: 1rem; }
      #airplane { font-size: 50px; }

      /* ===== Mobile cards: unified, slightly shorter height ===== */
      .card {
        width: min(95vw, 420px);
        padding: 10px 12px;
        font-size: clamp(14px, 4vw, 18px);
        height: var(--card-target-height, 340px);     /* equal height */
        max-height: var(--card-target-height, 340px);
        overflow-y: hidden;                            /* lock the height */
      }

      /* Base slideshow height on mobile ‚Äì JS fine-tunes per card */
      .slideshow { height: 180px; }
      .card img {
        display: block;
        width: 100%;
        height: auto;
        object-fit: cover;
        border-radius: 5px;
      }
      .card p { margin: 8px 0 0; line-height: 1.25; }
    }

    @keyframes pulseFade { 0%,100%{opacity:.5;transform:scale(1)} 50%{opacity:1;transform:scale(1.05)} }
    @keyframes vibrate {
      0% { transform: translateX(0); }
      20% { transform: translateX(-1px); }
      40% { transform: translateX(1px); }
      60% { transform: translateX(-1px); }
      80% { transform: translateX(2px); }
      100% { transform: translateX(0); }
    }
    .pulsating-vibrating { animation: pulseFade 1.5s infinite ease-in-out, vibrate 1s infinite linear; }

    /* Taller slideshow for bigger images (desktop base) */
    .slideshow { position: relative; width: 100%; height: 260px; overflow: hidden; border-radius: 6px; }
    .slideshow .slide { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity .5s ease; }
    .slideshow .slide.active { opacity: 1; }
    .slide-controls { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 6px; }
    .slide-controls button { background: #ff69b4; color: #fff; border: none; border-radius: 6px; padding: 4px 10px; cursor: pointer; font-family: 'Pacifico', cursive; font-size: 16px; }
    .dots { display: flex; gap: 6px; align-items: center; justify-content: center; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #ffd1e6; display: inline-block; cursor: pointer; }
    .dot.active { background: #ff69b4; }
  </style>
</head>
<body>
  <div id="loadingScreen">
    <div class="ml11">
      <span class="letters">Preparing your surprise7<span id="dots">...</span></span>
    </div>
    <div class="loading-bar-container">
      <div class="loading-bar" id="loadingBar"></div>
    </div>
    <div class="loading-percentage" id="loadingPercentage">0%</div>
    <div class="continue-text" id="continueText">[Press ENTER or Tap to continue]</div>
  </div>

  <div class="title">üéÇ Happy Birthday name üéÇ</div>
  <div id="globeViz"></div>
  <div id="popup" class="popup"></div>
  <div class="subtitle">From country1 to country2, to country3... and beyond ‚ù§Ô∏è</div>

  <div id="airplane">‚úàÔ∏è</div>

  <div id="infoCard" class="card"></div>
  <div class="nav-buttons">
    <button id="prevBtn" style="display:none;">‚¨Ö Previous</button>
    <button id="nextBtn" style="display:none;">Next ‚û°</button>
    <button id="endBtn" style="display:none;">End üéâ</button>
    <button id="startBtn" class="pulsing">Start ‚úàÔ∏è</button>
  </div>

  <script src="https://unpkg.com/globe.gl"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    // Animated dots
    setInterval(() => {
      const dots = document.getElementById('dots');
      dots.textContent = dots.textContent.length >= 3 ? '' : dots.textContent + '.';
    }, 500);

    // Simulate loading
    let load = 0;
    const bar = document.getElementById('loadingBar');
    const perc = document.getElementById('loadingPercentage');
    const contText = document.getElementById('continueText');
    const interval = setInterval(() => {
      if (load < 100) {
        load++;
        bar.style.width = load + '%';
        perc.textContent = load + '%';
      } else {
        clearInterval(interval);
        contText.style.opacity = 1;
        contText.classList.add('pulsating-vibrating');
      }
    }, 30);

    document.addEventListener('keydown', e => {
      if (e.key === 'Enter' && load >= 100) document.getElementById('loadingScreen').style.display = 'none';
    });
    document.addEventListener('click', () => {
      if (load >= 100) document.getElementById('loadingScreen').style.display = 'none';
    });

    setInterval(() => {
      confetti({ particleCount: 80, spread: 120, origin: { y: Math.random(), x: Math.random() }, zIndex: 0 });
    }, 1500);

    const elem = document.getElementById('globeViz');
    const card = document.getElementById('infoCard');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const endBtn = document.getElementById('endBtn');
    const startBtn = document.getElementById('startBtn');
    const airplane = document.getElementById('airplane');

    const places = [
      { lat: 25.0, lng: 19.0, name: "Turkey", message: "We first crossed paths here ‚Äî two lives meeting in the middle of a busy world. I didn‚Äôt know it then, but that moment was the start of something extraordinary.", imgs: ["image1.jpg","image1b.jpg"] },
      { lat: 26.5, lng: 42.2, name: "Azerbaijan", message: "You returned home, and I went my way‚Ä¶ but the distance never truly kept us apart. Every day we spoke, every day we laughed, and with every word our connection grew stronger.", imgs: ["image2.jpg","image2b.jpg"] },
      { lat: 22.5, lng: 14.5, name: "Greece", message: "Then you came to visit, and we turned days into memories. From sunlit streets to quiet moments by the sea, Greece became our playground of joy.", imgs: ["image3.jpg","image3b.jpg"] },
      { lat: 49.5, lng: 5.0, name: "Sweden", message: "Now, our eyes are set on a new horizon ‚Äî a place to start fresh, to dream bigger, and to build a life together one step at a time.", imgs: ["image4.jpg","image4b.jpg"] },
      { lat: 51.0, lng: -29.5, name: "Iceland", message: "And one day soon, we‚Äôll stand here, surrounded by the colors of the northern sky, living out a dream we‚Äôve carried in our hearts all along", imgs: ["image5.jpg","image5b.jpg"] }
    ];

    let currentIndex = -1;
    let slideshowTimer = null;

    const world = Globe()(elem)
      .globeImageUrl('earth-cartoon.png')
      .bumpImageUrl(null)
      .backgroundColor('rgba(0,0,0,0)')
      .pointOfView({ lat: 20, lng: 0, altitude: 2 }, 0)
      .labelsData(places)
      .labelLat(d => d.lat)
      .labelLng(d => d.lng)
      .labelText(d => d.name)
      .labelSize(1)
      .labelDotRadius(0.65)
      .labelColor(() => 'white');

    // üîß Use same DOWN offset across devices
    function getLatDownOffset() { return 8; }

    /* Position the card so its BOTTOM edge sits just above the pin */
    function positionCardAbovePin(place, gap = 10) {
      const coords = world.getScreenCoords(place.lat, place.lng);
      if (!coords) return;

      // Make sure it's in the layout but hidden
      if (card.style.display === 'none') card.style.display = 'block';
      card.style.visibility = 'hidden';
      card.style.left = '-10000px';
      card.style.top  = '-10000px';
      card.style.transform = 'translate(0,0)';

      // Measure after content is in
      const h = card.offsetHeight || 0;

      // Place centered horizontally at pin.x and just above pin.y
      card.style.left = coords.x + 'px';
      card.style.top  = (coords.y - h - gap) + 'px';
      card.style.transform = 'translateX(-50%)';
    }

    function revealCard() {
      card.style.visibility = 'visible';
    }

    // Keep cards from ever overlapping the title on desktop
    function clampCardMaxHeightToTitle() {
      const isMobile = window.matchMedia('(max-width: 600px)').matches;
      if (isMobile) return;

      const title = document.querySelector('.title');
      const rect = title.getBoundingClientRect();
      // space available between title bottom and viewport bottom
      const safeGap = 20; // breathing room
      const avail = Math.max(160, window.innerHeight - rect.bottom - safeGap);
      card.style.maxHeight = avail + 'px';
      card.style.overflowY = 'auto'; // if content exceeds clamp, scroll inside card
    }

    // Make all mobile cards the same (short) height by resizing the slideshow area
    function () {
      const isMobile = window.matchMedia('(max-width: 600px)').matches;
      if (!isMobile) return;

      const target = 330;               // unified mobile height (shorter than before)
      document.documentElement.style.setProperty('--card-target-height', target + 'px');

      // measure what's around the slideshow to compute its needed height
      const slideshow = card.querySelector('.slideshow');
      if (!slideshow) return;

      // measure current layout
      const totalNow = card.offsetHeight;
      const otherHeight = totalNow - slideshow.offsetHeight;

      // desired slideshow height so that card hits the exact target
      const desiredSlideH = Math.max(140, target - otherHeight);
      slideshow.style.height = desiredSlideH + 'px';
    }

    // Build + run slideshow for the current place
    function updateCard(index) {
      const place = places[index];

      // Build slideshow HTML (2 images)
      const slidesHtml = place.imgs.map((src, i) =>
        `<img class="slide ${i === 0 ? 'active' : ''}" src="${src}" alt="${place.name} photo ${i+1}">`
      ).join('');

      const dotsHtml = place.imgs.map((_, i) =>
        `<span class="dot ${i === 0 ? 'active' : ''}" data-idx="${i}"></span>`
      ).join('');

      // Insert content but keep hidden until after POV finishes
      card.style.display = 'block';
      card.style.visibility = 'hidden';
      card.innerHTML = `
        <div class="slideshow" aria-label="${place.name} photos (slideshow)">
          ${slidesHtml}
        </div>
        <div class="slide-controls">
          <button class="slide-prev" aria-label="Previous image">‚Äπ</button>
          <div class="dots">${dotsHtml}</div>
          <button class="slide-next" aria-label="Next image">‚Ä∫</button>
        </div>
        <p>${place.message}</p>
      `;

      // Wire up slideshow controls
      let imgIdx = 0;
      const slides = card.querySelectorAll('.slide');
      const dots = card.querySelectorAll('.dot');
      const prev = card.querySelector('.slide-prev');
      const next = card.querySelector('.slide-next');
      const slideshowEl = card.querySelector('.slideshow');

      function show(n) {
        imgIdx = (n + slides.length) % slides.length;
        slides.forEach((el, i) => el.classList.toggle('active', i === imgIdx));
        dots.forEach((el, i) => el.classList.toggle('active', i === imgIdx));
        positionCardAbovePin(place); // adjust if height changes
      }

      prev.addEventListener('click', () => show(imgIdx - 1));
      next.addEventListener('click', () => show(imgIdx + 1));
      dots.forEach(d => d.addEventListener('click', () => show(parseInt(d.dataset.idx))));
      slideshowEl.addEventListener('click', () => show(imgIdx + 1));

      // Swipe (basic)
      let startX = null;
      slideshowEl.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; }, { passive: true });
      slideshowEl.addEventListener('touchend', (e) => {
        if (startX == null) return;
        const dx = e.changedTouches[0].clientX - startX;
        if (Math.abs(dx) > 30) show(imgIdx + (dx < 0 ? 1 : -1));
        startX = null;
      }, { passive: true });

      // Show nav buttons
      prevBtn.style.display = index > 0 ? 'inline-block' : 'none';
      nextBtn.style.display = index < places.length - 1 ? 'inline-block' : 'none';
      endBtn.style.display = index === places.length - 1 ? 'inline-block' : 'none';

      // Desktop clamp + Mobile equalization (do this before measuring/placing)
      normalizeCardHeightMobile();
      clampCardMaxHeightToTitle();

      // Move camera first; keep card hidden during the motion
      const latOffset = getLatDownOffset(place.name);
      world.pointOfView({
        lat: parseFloat(place.lat) + latOffset,
        lng: parseFloat(place.lng),
        altitude: 0.8
      }, 2000);

      // After POV animation finishes, position and reveal with NO intermediate flash
      setTimeout(() => {
        positionCardAbovePin(place);
        revealCard();
      }, 2050);
    }

    function flyPlaneTo(lat, lng, callback) {
      const targetX = window.innerWidth / 2 + (lng / 180) * (window.innerWidth / 2);
      const targetY = window.innerHeight / 2 - (lat / 90) * (window.innerHeight / 2);
      const dx = targetX - airplane.offsetLeft;
      const dy = targetY - airplane.offsetTop;
      const angle = Math.atan2(dy, dx) * 180 / Math.PI;
      const steps = 150;
      let step = 0;
      const startX = airplane.offsetLeft;
      const startY = airplane.offsetTop;

      function animate() {
        step++;
        const t = step / steps;
        const curveY = startY + dy * t - 50 * Math.sin(Math.PI * t);
        airplane.style.left = startX + dx * t + 'px';
        airplane.style.top = curveY + 'px';
        airplane.style.transform = `rotate(${angle}deg)`;

        if (step < steps) {
          requestAnimationFrame(animate);
        } else {
          if (callback) callback();
        }
      }
      animate();
    }

    startBtn.addEventListener('click', () => {
      startBtn.classList.remove('pulsing');
      startBtn.disabled = true;
      currentIndex = 0;
      // Hide card completely during plane animation and initial POV setup
      card.style.display = 'none';
      card.style.visibility = 'hidden';
      flyPlaneTo(places[0].lat, places[0].lng, () => {
        updateCard(0);
        nextBtn.style.display = 'inline-block';
        startBtn.style.display = 'none';
      });
    });

    nextBtn.addEventListener('click', () => {
      if (currentIndex < places.length - 1) {
        nextBtn.disabled = true;
        currentIndex++;
        // Hide card until moved and placed
        card.style.display = 'none';
        card.style.visibility = 'hidden';
        flyPlaneTo(places[currentIndex].lat, places[currentIndex].lng, () => {
          updateCard(currentIndex);
          nextBtn.disabled = false;
        });
      }
    });

    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        prevBtn.disabled = true;
        currentIndex--;
        // Hide card until moved and placed
        card.style.display = 'none';
        card.style.visibility = 'hidden';
        flyPlaneTo(places[currentIndex].lat, places[currentIndex].lng, () => {
          updateCard(currentIndex);
          prevBtn.disabled = false;
        });
      }
    });

    endBtn.addEventListener('click', () => {
      if (slideshowTimer) clearInterval(slideshowTimer);
      card.innerHTML = "<h2>üéâ Happy Birthday! üéâ</h2><p>And through it all, one truth remains ‚Äî you are my favorite story, my greatest adventure, and my happiest place. Happy 25th birthday, omorfia mou. Here‚Äôs to all the journeys still ahead. ‚ù§Ô∏è</p>";
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      endBtn.style.display = 'none';
      // Keep card above final pin
      positionCardAbovePin(places[currentIndex]);
      revealCard();
    });

    // Reposition + re-apply sizing on window resize
    window.addEventListener('resize', () => {
      if (currentIndex >= 0) {
        normalizeCardHeightMobile();
        clampCardMaxHeightToTitle();
        positionCardAbovePin(places[currentIndex]);
      }
    });
  </script>
</body>
</html>
